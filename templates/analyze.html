<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Analyse de la capture</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0d1b2a; /* Fond bleu sombre */
      text-align: center;
      padding: 20px;
      color: #f4f4f9; /* Texte clair */
    }

    h1 {
      margin-bottom: 20px;
      color: #ffffff;
      font-size: 2.5rem; /* Titre agrandi */
      font-weight: bold;
    }

    h2 {
      color: #000000;
      margin-top: 25px;
    }

    img {
      max-width: 90%;
      border-radius: 12px;
      margin: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    }

    .btn {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 8px;
      background: #1d4ed8; /* Bleu vif */
      color: white;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .btn:hover {
      background: #1e40af; /* Plus fonc√© au hover */
    }

    .chat-box {
      text-align: left;
      background: #ffffff;
      color: #000;
      padding: 15px;
      border-radius: 10px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .grid-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: grid;
      grid-template-rows: repeat(4, 1fr);
      grid-template-columns: repeat(4, 1fr);
      width: 100%;
      height: 100%;
      z-index: 10;
      user-select: none;
    }
    .grid-overlay div {
      border: 1px solid rgba(255,255,255,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      color: white;
    }
    .grid-overlay div.selected {
      background: rgba(255, 255, 0, 0.3);
    }
    .extraction-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }
    .extraction-item img {
      border: 2px solid #6c63ff;
      border-radius: 8px;
      max-width: 200px;
    }
    .download-btn {
      padding: 5px 10px;
      font-size: 14px;
      border: none;
      background-color: #2563eb;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }
    .download-btn:hover {
      background-color: #1e3a8a;
    }
    .container {
        display: flex;
        gap: 30px;
        margin-top: 20px;
    }
    .image-box {
        flex: 2;
    }
    .results-box {
        flex: 1;
        background: white;
        color: black;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }
    table, th, td {
        border: 1px solid #ddd;
    }
    th, td {
        text-align: center;
        padding: 8px;
    }
    th {
        background: #eee;
    }
    .controls {
        margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <h1>Analyse de l'image : {{ filename }}</h1>

  <!-- Choix de traitement -->
  <form action="{{ url_for('analyze', filename=filename) }}" method="post" style="margin-top:20px;">
    <label for="method">Choisir un traitement :</label>
    <select name="method" id="method">
      <option value="gray" {% if method == "gray" %}selected{% endif %}>Niveaux de gris</option>
      <option value="blur" {% if method == "blur" %}selected{% endif %}>Flou gaussien</option>
      <option value="contrast" {% if method == "contrast" %}selected{% endif %}>Am√©lioration des contrastes</option>
      <option value="sharpen" {% if method == "sharpen" %}selected{% endif %}>Filtre de nettet√©</option>
      <option value="faces" {% if method == "faces" %}selected{% endif %}>D√©tection de visages</option>
      <option value="mediapipe" {% if method == "mediapipe" %}selected{% endif %}>D√©tection d‚Äôobjets (Mediapipe)</option>
      <option value="yolo" {% if method == "yolo" %}selected{% endif %}>D√©tection d‚Äôobjets (yolo)</option>
      <option value="edges" {% if method == "edges" %}selected{% endif %}>D√©tection de contours</option>
    </select>
    <button type="submit" class="btn">Analyser</button>
  </form>

  <!-- Affichage de l'image avec grille -->
  <div style="position:relative; display:inline-block;">
    <img src="{{ url_for('static', filename=filename) }}" 
         id="image-analyzed" 
         alt="Image analys√©e">
    <div class="grid-overlay" id="grid-overlay"></div>
  </div>

  <!-- Bouton toggle grille -->
  <div style="margin-top:10px;">
    <button onclick="toggleGrid()" class="btn" style="background:#6c63ff;">
      üéõÔ∏è Afficher/Masquer la grille
    </button>
  </div>

  <!-- Zone d‚Äôaffichage des extractions -->
  <div style="color:white; font-size:2rem;">
    üì∏ Extractions
  </div>
  <div id="extractions" style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center;"></div>

  <!-- Image analys√©e avec un tableau listant les objets d√©tect√©s (Yolo) -->
    <div class="container">
        <!-- Image annot√©e -->
        <div class="image-box">
            <img src="{{ url_for('static', filename=analyzed) }}" alt="Image analys√©e">
        </div>

        <!-- R√©sultats -->
        <div class="results-box">
            <h2>R√©sultats</h2>
            {% if detections and detections|length > 0 %}
                <p>{{ detections|length }} √©l√©ment(s) d√©tect√©(s).</p>
                <table>
                    <thead>
                        <tr>
                            <th>Label</th>
                            <th>Confiance</th>
                            <th>Coordonn√©es</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for det in detections %}
                            <tr>
                                <td>{{ det[0].split('(')[0].strip() }}</td>
                                <td>{{ det[0].split('(')[1].replace(')', '') if '(' in det[0] else 'N/A' }}</td>
                                <td>
                                    {% set x1,y1,x2,y2 = det[1] %}
                                    ({{x1}}, {{y1}}) ‚Üí ({{x2}}, {{y2}})
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>Aucun objet d√©tect√©.</p>
            {% endif %}
        </div>
    </div>

  <!-- Chat avec OpenAI -->
  <div style="color:white; font-size:2rem;">
    ü§ñ Discussion avec OpenAI
  </div>
  <div class="chat-box">
    {% if chat_history %}
      {% for entry in chat_history %}
        <div style="margin-bottom:15px;">
          <p><b>üë§ Toi :</b> {{ entry.question }}</p>
          <p style="background:#e9f7ff; padding:10px; border-radius:8px;">
            <b>ü§ñ OpenAI :</b> {{ entry.answer }}
          </p>
        </div>
      {% endfor %}
    {% else %}
      <p><i>Aucune question pos√©e pour l‚Äôinstant.</i></p>
    {% endif %}
  </div>

  <form action="{{ url_for('ask_openai', filename=filename) }}" method="post" style="margin-top:15px;">
    <textarea name="question" rows="3" 
              style="width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;" 
              placeholder="Pose une question sur cette image..."></textarea>
    <br>
    <button type="submit" class="btn" style="background:#17a2b8;">Envoyer</button>
  </form>

  <!-- Bouton suppression -->
  <form action="{{ url_for('delete', filename=filename) }}" method="post" style="margin-top:20px;">
    <button type="submit" class="btn" style="background:#dc3545;">üóëÔ∏è Supprimer l'image</button>
  </form>

  <br><br>
  <a href="{{ url_for('index') }}" class="btn">‚¨ÖÔ∏è Retour √† l'accueil</a>

  <script>
	  const overlay = document.getElementById("grid-overlay");
	  const img = document.getElementById("image-analyzed");
	  const extractions = document.getElementById("extractions");

	  let rows = 4, cols = 4;
	  let isDragging = false;
	  let startRow = null, startCol = null;

	  function createGrid(rows, cols) {
		overlay.innerHTML = "";
		let counter = 1;
		for (let row = 0; row < rows; row++) {
		  for (let col = 0; col < cols; col++) {
			const cell = document.createElement("div");
			cell.textContent = counter;
			cell.dataset.row = row;
			cell.dataset.col = col;
			overlay.appendChild(cell);
			counter++;
		  }
		}
	  }

	  function clearSelection() {
		overlay.querySelectorAll("div").forEach(c => c.classList.remove("selected"));
	  }

	  overlay.addEventListener("mousedown", (e) => {
		if (e.target.dataset.row !== undefined) {
		  isDragging = true;
		  startRow = parseInt(e.target.dataset.row);
		  startCol = parseInt(e.target.dataset.col);
		  clearSelection();
		}
	  });

	  overlay.addEventListener("mousemove", (e) => {
		if (isDragging && e.target.dataset.row !== undefined) {
		  let endRow = parseInt(e.target.dataset.row);
		  let endCol = parseInt(e.target.dataset.col);

		  clearSelection();

		  const minRow = Math.min(startRow, endRow);
		  const maxRow = Math.max(startRow, endRow);
		  const minCol = Math.min(startCol, endCol);
		  const maxCol = Math.max(startCol, endCol);

		  overlay.querySelectorAll("div").forEach(cell => {
			const r = parseInt(cell.dataset.row);
			const c = parseInt(cell.dataset.col);
			if (r >= minRow && r <= maxRow && c >= minCol && c <= maxCol) {
			  cell.classList.add("selected");
			}
		  });
		}
	  });

	  overlay.addEventListener("mouseup", (e) => {
		if (isDragging && e.target.dataset.row !== undefined) {
		  isDragging = false;
		  let endRow = parseInt(e.target.dataset.row);
		  let endCol = parseInt(e.target.dataset.col);

		  extractRectangle(startRow, startCol, endRow, endCol, rows, cols);
		}
	  });

		function extractRectangle(r1, c1, r2, c2, rows, cols) {
		  const minRow = Math.min(r1, r2);
		  const maxRow = Math.max(r1, r2);
		  const minCol = Math.min(c1, c2);
		  const maxCol = Math.max(c1, c2);

		  const cellWidth = img.naturalWidth / cols;
		  const cellHeight = img.naturalHeight / rows;

		  const x = minCol * cellWidth;
		  const y = minRow * cellHeight;
		  const w = (maxCol - minCol + 1) * cellWidth;
		  const h = (maxRow - minRow + 1) * cellHeight;

		  const canvas = document.createElement("canvas");
		  const ctx = canvas.getContext("2d");
		  canvas.width = w;
		  canvas.height = h;

		  ctx.drawImage(img, x, y, w, h, 0, 0, w, h);

		  const croppedData = canvas.toDataURL("image/png");

		  fetch("/save_extraction", {
			method: "POST",
			headers: {"Content-Type": "application/json"},
			body: JSON.stringify({image: croppedData})
		  })
		  .then(res => res.json())
		  .then(data => {
			if (data.path) {
			  const container = document.createElement("div");
			  container.classList.add("extraction-item");

			  const newImg = document.createElement("img");
			  newImg.src = data.path;

			  const downloadBtn = document.createElement("a");
			  downloadBtn.href = data.path;
			  downloadBtn.download = data.path.split("/").pop();
			  downloadBtn.textContent = "‚¨á T√©l√©charger";
			  downloadBtn.classList.add("download-btn");

			  container.appendChild(newImg);
			  container.appendChild(downloadBtn);
			  extractions.appendChild(container);
			}
		  });
		}
				
	  createGrid(rows, cols);

    function toggleGrid() {
      if (overlay.style.display === "none") {
        overlay.style.display = "grid";
      } else {
        overlay.style.display = "none";
      }
    }

  </script>
</body>
</html>
